# .github/workflows/enrich.yml
name: Nightlyâ€¯Algoliaâ€¯Enrichment

on:
  schedule:
    # Runs every day at 02:17Â UTC  â†’Â  adjust if you prefer
    - cron: '17 2 * * *'
  workflow_dispatch:            # manual trigger button

env:
  # Reâ€‘use repo secrets â†’ define these in Settings â–¸ Secrets â–¸ Actions
  ALGOLIA_APP_ID        : ${{ secrets.ALGOLIA_APP_ID }}
  ALGOLIA_ADMIN_KEY     : ${{ secrets.ALGOLIA_ADMIN_KEY }}
  OPENAI_API_KEY        : ${{ secrets.OPENAI_API_KEY }}
  # optional nightly cost cap / batch size (string envs)
  ENRICH_OPENAI_DOLLAR_CAP: '1.20'
  ENRICH_BATCH_SIZE        : '50'

jobs:
  enrich:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸  Checkout repo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup NodeÂ 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ğŸ“¦ Install deps
        run: npm ci --ignore-scripts

      - name: ğŸ” Typeâ€‘check (optional)
        run: npx tsc -p tsconfig.json --noEmit

      - name: ğŸš€ Run enrichment script
        run: npx ts-node scripts/enrich_jobs.ts

      - name: âœ… Summary
        if: success()
        run: echo "â­ï¸  jobs enrichment completed OK"

      - name: âš ï¸ Upload action logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: enrich_logs
          path: ${{ runner.temp }}/_diag  # created by enrich_jobs on error
          retention-days: 3
