name: Nightly Job â€“ Vector Enrich

on:
  schedule:
    - cron: '0 4 * * *'        # 04â€¯:00Â UTC every day
  workflow_dispatch:            # manual â€œRun workflowâ€ button

jobs:
  enrich:
    runs-on: ubuntu-latest

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sideâ€‘car services (same level as defaults / steps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    services:
      redis:
        image: redis/redis-stack-server:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    # all `run:` commands start in mcp-server/
    defaults:
      run:
        working-directory: mcp-server

    steps:
      - name: ğŸ“¥Â Checkout
        uses: actions/checkout@v4

      - name: ğŸ› Â Setup NodeÂ 20 + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mcp-server/package-lock.json

      - name: ğŸ“¦Â Install deps (npm ci)
        run: npm ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ optional debug helpers (remove later) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Dump env secrets that reached the runner
        run: env | grep -E 'OPENAI|ALGOLIA|REDIS' || true

      - name: ğŸ” Show top of quota script
        run: |
          echo 'â”€â”€â”€ mcpâ€‘server/scripts/check_openai_quota.ts (head) â”€â”€â”€'
          cat scripts/check_openai_quota.ts
          echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ğŸ§® Check OpenAI quota
        env:
          OPENAI_API_KEY:         ${{ secrets.OPENAI_API_KEY }}
          OPENAI_HARD_LIMIT_USD:  ${{ secrets.OPENAI_HARD_LIMIT_USD }}
        run: |
          echo "API key present? ${OPENAI_API_KEY:+yes}"
          echo "Hard limit: $OPENAI_HARD_LIMIT_USD"
          npx tsx scripts/check_openai_quota.ts

      - name: ğŸš€ Run nightly embedding job
        env:
          OPENAI_API_KEY:         ${{ secrets.OPENAI_API_KEY }}
          ALGOLIA_APP_ID:         ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ADMIN_KEY:      ${{ secrets.ALGOLIA_ADMIN_KEY }}
          OPENAI_HARD_LIMIT_USD:  ${{ secrets.OPENAI_HARD_LIMIT_USD }}
          REDIS_URL:              redis://localhost:6379
        run: npx tsx scripts/enrich_jobs.ts --verbose
