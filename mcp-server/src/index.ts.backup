import express from 'express';
import dotenv  from 'dotenv';
import searchRouter from './routes/search';
import favoritesRouter  from './routes/favorites';
import resumeRouter from './routes/resume';
import recommendRouter from './routes/recommend';
import jobsRouter from './routes/jobs';
import sseFavoritesRouter from './routes/sse-favorites';
import favoritesTotalRouter from './routes/favorites-total';
import favoritesTrendRouter from './routes/favorites-trend';
import { initializePubSub } from './lib/pubsub';
import { jobsIndex } from './lib/algolia'; // still used by /recommend
import { ensureCacheIndex } from './lib/createCacheIndex';
import { generalApiLimiter, searchLimiter } from './middleware/rateLimiter';
import { validateSearchRequest } from './middleware/requestValidation';
import { usageMonitor } from './middleware/usageMonitor';

dotenv.config();

const app = express();

// Apply general rate limiting to all API routes
app.use('/api', generalApiLimiter);

app.use(express.json({ limit: '10mb' }));   // plenty for a 7 000â€‘token rÃ©sumÃ©
app.use(express.text({ limit: '10mb', type: 'text/plain' }));

// (optional) if you also accept urlâ€‘encoded forms anywhere:
// app.use(express.urlencoded({ extended: true, limit: '1mb' }));

/* ------------------------------------------------------------- */
/*  Search API (GET /api/search?... )                            */
/* ------------------------------------------------------------- */
app.use('/api/search', searchLimiter, validateSearchRequest, searchRouter);

/* ---------------- Favorites -------------- */
app.use('/api/favorites',  favoritesRouter);  // â† NEW

/* ---------------- Resume -------------- */
app.use('/api/resume',  resumeRouter);  // â† NEW

/* ---------------- Recommend -------------- */
app.use('/api/recommend', recommendRouter);

/* ---------------- Jobs -------------- */
app.use('/api/jobs', jobsRouter);

/* ---------------- SSE Events -------------- */
app.use('/api/events', sseFavoritesRouter);
app.use('/api/favorites-total', favoritesTotalRouter);
app.use('/api/favorites-trend', favoritesTrendRouter);

/* ---------------- Usage Monitoring -------------- */
app.get('/api/admin/usage', async (req, res) => {
  try {
    const stats = await usageMonitor.getUsageStats(7); // Last 7 days
    res.json({
      message: 'Usage statistics for last 7 days',
      stats: stats,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Failed to get usage stats:', error);
    res.status(500).json({ error: 'Failed to get usage stats' });
  }
});

/* ---------------- Health Check -------------- */
app.get('/health', (_req, res) => {
  res.status(200).json({ status: 'ok', timestamp: new Date().toISOString() });
});

/* ------------------------------------------------------------- */
/*  Start the server                                             */
/* ------------------------------------------------------------- */
const PORT = process.env.PORT || 4000;

// Graceful shutdown handling
async function gracefulShutdown(signal: string) {
  console.log(`ğŸ›‘ Received ${signal}, shutting down gracefully...`);
  
  try {
    // Close Redis connections
    const redis = await import('./lib/redis');
    const { getPubClient, getSubClient } = await import('./lib/pubsub');
    
    // Close main Redis client
    if (redis.default) {
      await redis.default.quit();
      console.log('ğŸ”Œ Main Redis connection closed');
    }
    
    // Close pub/sub clients
    const pubClient = await getPubClient();
    const subClient = await getSubClient();
    
    if (pubClient) {
      await pubClient.quit();
      console.log('ğŸ”Œ Redis publisher closed');
    }
    
    if (subClient) {
      await subClient.quit();
      console.log('ğŸ”Œ Redis subscriber closed');
    }
    
    console.log('âœ… Graceful shutdown completed');
  } catch (error) {
    console.error('âŒ Error during graceful shutdown:', error);
  }
  
  process.exit(0);
}

// Handle shutdown signals
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

(async () => {
  try {
    await initializePubSub();
    await ensureCacheIndex();
    console.log('âœ… PubSub initialized');
    console.log('âœ… Cache index ensured');
    
    app.listen(PORT, () => {
      console.log(`ğŸš€ Server running on port ${PORT}`);
      console.log(`ğŸ›¡ï¸  Security middleware active`);
      console.log(`ğŸ“Š Usage monitoring available at /api/admin/usage`);
    });
  } catch (error) {
    console.error('âŒ Failed to start server:', error);
    process.exit(1);
  }
})();
