name: Nightly Job – Vector Enrich

on:
  schedule:
    - cron:  '0 4 * * *'       # 04:00 UTC, 15 min before prune
  workflow_dispatch:

jobs:
  enrich:
    runs-on: ubuntu-latest

       # ─────────────────────── Redis side‑car ──────────────────────
    services:
      redis:
        image: redis:7                # official image, latest 7.x
        ports:
          - 6379:6379                 # expose on the runner
        options: >-                   # optional health‑check
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
   # ──────────────────────────────────────────────────────────────
    
    # All steps start in mcp-server/
    defaults:
      run:
        working-directory: mcp-server

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4       # same as prune.yml
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mcp-server/package-lock.json

      - name: Install deps
        run: npm ci


      - name: Debug ‑ show check_quota script
        run: |
          echo '─── mcp‑server/scripts/check_openai_quota.ts (head) ───'
          cat scripts/check_openai_quota.ts | head -n 20
          echo '───────────────────────────────────────────────────────'


      - name: Check OpenAI quota
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ALGOLIA_APP_ID   : ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ADMIN_KEY: ${{ secrets.ALGOLIA_ADMIN_KEY }}
          OPENAI_HARD_LIMIT_USD: ${{ secrets.OPENAI_HARD_LIMIT_USD }}
        run: npx tsx scripts/check_openai_quota.ts

      - name: Run nightly embedding job
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ALGOLIA_APP_ID   : ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ADMIN_KEY: ${{ secrets.ALGOLIA_ADMIN_KEY }}
          OPENAI_HARD_LIMIT_USD: ${{ secrets.OPENAI_HARD_LIMIT_USD }}
        run: npx tsx scripts/enrich_jobs.ts
