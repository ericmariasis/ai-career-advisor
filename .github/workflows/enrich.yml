# .github/workflows/enrich.yml
name: Nightly Algolia Enrichment

on:
  schedule:
    # Runs every day at 02:17 UTC  →  adjust if you prefer
    - cron: '17 2 * * *'
  workflow_dispatch:            # manual trigger button

env:
  # Re‑use repo secrets → define these in Settings ▸ Secrets ▸ Actions
  ALGOLIA_APP_ID        : ${{ secrets.ALGOLIA_APP_ID }}
  ALGOLIA_ADMIN_KEY     : ${{ secrets.ALGOLIA_ADMIN_KEY }}
  OPENAI_API_KEY        : ${{ secrets.OPENAI_API_KEY }}
  # optional nightly cost cap / batch size (string envs)
  ENRICH_OPENAI_DOLLAR_CAP: '1.20'
  ENRICH_BATCH_SIZE        : '50'

jobs:
  enrich:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️  Checkout repo
        uses: actions/checkout@v4

      - name: 🟢 Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: 📦 Install deps
        run: npm ci --ignore-scripts

      - name: 🔍 Type‑check (optional)
        run: npx tsc -p tsconfig.json --noEmit

      - name: 🚀 Run enrichment script
        run: npx ts-node scripts/enrich_jobs.ts

      - name: ✅ Summary
        if: success()
        run: echo "⭐️  jobs enrichment completed OK"

      - name: ⚠️ Upload action logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: enrich_logs
          path: ${{ runner.temp }}/_diag  # created by enrich_jobs on error
          retention-days: 3
